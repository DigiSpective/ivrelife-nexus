<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Comprehensive Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        button { margin: 5px; padding: 8px 16px; background: #333; color: #0f0; border: 1px solid #666; cursor: pointer; }
        button:disabled { background: #222; color: #666; }
        pre { background: #111; padding: 10px; border: 1px solid #333; white-space: pre-wrap; max-height: 200px; overflow-y: auto; font-size: 12px; }
        .success { color: #4f4; }
        .error { color: #f44; }
        .warning { color: #fa4; }
        .section { margin: 15px 0; padding: 10px; border: 1px solid #333; }
        .status { padding: 3px; margin: 3px 0; font-weight: bold; font-size: 14px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <h1>üî¨ Final Comprehensive Persistence Test</h1>
    
    <div class="grid">
        <div class="section">
            <h3>üîß Test 1: Supabase Client</h3>
            <button onclick="testSupabaseClient()">Test Client</button>
            <div id="client-status" class="status">Ready</div>
            <pre id="client-log"></pre>
        </div>
        
        <div class="section">
            <h3>üîë Test 2: Authentication</h3>
            <button id="auth-btn" onclick="testAuth()" disabled>Test Auth</button>
            <div id="auth-status" class="status">Waiting...</div>
            <pre id="auth-log"></pre>
        </div>
        
        <div class="section">
            <h3>üì• Test 3: Load Orders</h3>
            <button id="load-btn" onclick="testLoadOrders()" disabled>Load Orders</button>
            <div id="load-status" class="status">Waiting...</div>
            <pre id="load-log"></pre>
        </div>
        
        <div class="section">
            <h3>üìù Test 4: Create Order</h3>
            <button id="create-btn" onclick="testCreateOrder()" disabled>Create Order</button>
            <div id="create-status" class="status">Waiting...</div>
            <pre id="create-log"></pre>
        </div>
        
        <div class="section">
            <h3>üîÑ Test 5: Verify Persistence</h3>
            <button id="verify-btn" onclick="testPersistence()" disabled>Verify</button>
            <div id="verify-status" class="status">Waiting...</div>
            <pre id="verify-log"></pre>
        </div>
        
        <div class="section">
            <h3>üéØ Test 6: Full Simulation</h3>
            <button id="simulate-btn" onclick="simulateAppFlow()" disabled>Simulate App</button>
            <div id="simulate-status" class="status">Waiting...</div>
            <pre id="simulate-log"></pre>
        </div>
    </div>
    
    <div class="section">
        <h2>üìä Final Results</h2>
        <div id="final-results" class="status">Testing in progress...</div>
        <div id="conclusion" style="margin-top: 10px; padding: 10px; border: 2px solid #666;"></div>
    </div>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        let supabase;
        let currentUser;
        let testOrderId;
        let testResults = {};
        
        function log(section, message, type = 'info') {
            const el = document.getElementById(`${section}-log`);
            if (el) {
                const time = new Date().toLocaleTimeString();
                const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : type === 'warning' ? '#fa4' : '#0f0';
                el.innerHTML += `<span style="color: ${color}">[${time}] ${message}</span>\n`;
                el.scrollTop = el.scrollHeight;
            }
        }
        
        function updateStatus(section, message, type = 'info') {
            const el = document.getElementById(`${section}-status`);
            if (el) {
                const color = type === 'error' ? '#f44' : type === 'success' ? '#4f4' : type === 'warning' ? '#fa4' : '#0f0';
                el.innerHTML = `<span style="color: ${color}">${message}</span>`;
            }
        }
        
        async function testSupabaseClient() {
            log('client', 'üîß Testing Supabase client creation...');
            try {
                supabase = window.supabase.createClient(
                    'https://qeiyxwuyhetnrnundpep.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlaXl4d3V5aGV0bnJudW5kcGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDQyMTEsImV4cCI6MjA3NDIyMDIxMX0.fkmN8zQXVv3m7VBcpIj1KfkspSb4a6K93RZVT8qiKak',
                    { auth: { autoRefreshToken: true, persistSession: true, detectSessionInUrl: true } }
                );
                
                const { data, error } = await supabase.from('orders').select('id').limit(1);
                
                if (error) {
                    log('client', `‚ùå Connection test failed: ${error.message}`, 'error');
                    testResults.client = false;
                    updateStatus('client', '‚ùå Failed', 'error');
                } else {
                    log('client', '‚úÖ Client and connection working', 'success');
                    testResults.client = true;
                    updateStatus('client', '‚úÖ Working', 'success');
                    document.getElementById('auth-btn').disabled = false;
                }
            } catch (error) {
                log('client', `‚ùå Exception: ${error.message}`, 'error');
                testResults.client = false;
                updateStatus('client', '‚ùå Exception', 'error');
            }
        }
        
        async function testAuth() {
            log('auth', 'üîë Testing authentication...');
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@iv-relife.com',
                    password: '123456789'
                });
                
                if (error) {
                    log('auth', `Sign in failed, trying signup: ${error.message}`);
                    const { data: signupData, error: signupError } = await supabase.auth.signUp({
                        email: 'admin@iv-relife.com',
                        password: '123456789'
                    });
                    
                    if (signupError) {
                        log('auth', `‚ùå Both signin and signup failed: ${signupError.message}`, 'error');
                        testResults.auth = false;
                        updateStatus('auth', '‚ùå Failed', 'error');
                        return;
                    } else {
                        currentUser = signupData.user;
                        log('auth', '‚úÖ Signup successful', 'success');
                    }
                } else {
                    currentUser = data.user;
                    log('auth', '‚úÖ Signin successful', 'success');
                }
                
                if (currentUser) {
                    log('auth', `User: ${currentUser.email} (${currentUser.id})`);
                    testResults.auth = true;
                    updateStatus('auth', '‚úÖ Authenticated', 'success');
                    document.getElementById('load-btn').disabled = false;
                    document.getElementById('simulate-btn').disabled = false;
                }
            } catch (error) {
                log('auth', `‚ùå Exception: ${error.message}`, 'error');
                testResults.auth = false;
                updateStatus('auth', '‚ùå Exception', 'error');
            }
        }
        
        async function testLoadOrders() {
            log('load', 'üì• Testing order loading...');
            try {
                const { data, error } = await supabase.from('orders').select('*').eq('created_by', currentUser.id);
                
                if (error) {
                    log('load', `‚ùå Load failed: ${error.message}`, 'error');
                    testResults.load = false;
                    updateStatus('load', '‚ùå Failed', 'error');
                } else {
                    log('load', `‚úÖ Loaded ${data.length} orders`, 'success');
                    testResults.load = true;
                    testResults.initialCount = data.length;
                    updateStatus('load', `‚úÖ ${data.length} orders`, 'success');
                    document.getElementById('create-btn').disabled = false;
                }
            } catch (error) {
                log('load', `‚ùå Exception: ${error.message}`, 'error');
                testResults.load = false;
                updateStatus('load', '‚ùå Exception', 'error');
            }
        }
        
        async function testCreateOrder() {
            log('create', 'üìù Testing order creation...');
            try {
                testOrderId = `final-test-${Date.now()}`;
                const orderData = {
                    id: testOrderId,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000',
                    customer_id: 'final-test-customer',
                    status: 'pending',
                    total_amount: 799.99,
                    items: JSON.stringify([{ product: 'Final Test Product', qty: 1, price: 799.99 }]),
                    created_by: currentUser.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase.from('orders').insert([orderData]).select().single();
                
                if (error) {
                    log('create', `‚ùå Create failed: ${error.message}`, 'error');
                    testResults.create = false;
                    updateStatus('create', '‚ùå Failed', 'error');
                } else {
                    log('create', `‚úÖ Created order: ${data.id}`, 'success');
                    testResults.create = true;
                    updateStatus('create', '‚úÖ Created', 'success');
                    document.getElementById('verify-btn').disabled = false;
                }
            } catch (error) {
                log('create', `‚ùå Exception: ${error.message}`, 'error');
                testResults.create = false;
                updateStatus('create', '‚ùå Exception', 'error');
            }
        }
        
        async function testPersistence() {
            log('verify', 'üîÑ Testing persistence...');
            try {
                const { data, error } = await supabase.from('orders').select('*').eq('created_by', currentUser.id);
                
                if (error) {
                    log('verify', `‚ùå Verification failed: ${error.message}`, 'error');
                    testResults.persistence = false;
                    updateStatus('verify', '‚ùå Failed', 'error');
                } else {
                    const foundOrder = data.find(o => o.id === testOrderId);
                    const newCount = data.length;
                    
                    if (foundOrder && newCount === testResults.initialCount + 1) {
                        log('verify', 'üéâ PERSISTENCE WORKING! Order found and count correct', 'success');
                        testResults.persistence = true;
                        updateStatus('verify', '‚úÖ Working', 'success');
                    } else if (foundOrder) {
                        log('verify', '‚ö†Ô∏è Order found but count issue', 'warning');
                        testResults.persistence = 'partial';
                        updateStatus('verify', '‚ö†Ô∏è Partial', 'warning');
                    } else {
                        log('verify', '‚ùå Order not found - persistence failed', 'error');
                        testResults.persistence = false;
                        updateStatus('verify', '‚ùå Failed', 'error');
                    }
                }
                
                showResults();
            } catch (error) {
                log('verify', `‚ùå Exception: ${error.message}`, 'error');
                testResults.persistence = false;
                updateStatus('verify', '‚ùå Exception', 'error');
                showResults();
            }
        }
        
        async function simulateAppFlow() {
            log('simulate', 'üéØ Simulating complete app flow...');
            updateStatus('simulate', 'üîÑ Running...', 'warning');
            
            try {
                // Step 1: Fresh auth check
                const { data: sessionData } = await supabase.auth.getSession();
                log('simulate', `Session check: ${sessionData.session ? 'Active' : 'None'}`);
                
                // Step 2: Load orders (like Orders page)
                const { data: ordersData, error: ordersError } = await supabase.from('orders').select('*');
                if (ordersError) {
                    log('simulate', `‚ùå Orders load failed: ${ordersError.message}`, 'error');
                    updateStatus('simulate', '‚ùå Failed', 'error');
                    return;
                }
                log('simulate', `‚úÖ App would show ${ordersData.length} total orders`);
                
                // Step 3: Create order (like NewOrder component)
                const appTestId = `app-sim-${Date.now()}`;
                const { data: createData, error: createError } = await supabase.from('orders').insert([{
                    id: appTestId,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000',
                    customer_id: 'app-simulation',
                    status: 'pending',
                    total_amount: 899.99,
                    items: JSON.stringify([{ product: 'App Sim Product', qty: 1, price: 899.99 }]),
                    created_by: currentUser.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }]).select().single();
                
                if (createError) {
                    log('simulate', `‚ùå App simulation create failed: ${createError.message}`, 'error');
                    updateStatus('simulate', '‚ùå Create Failed', 'error');
                    return;
                }
                log('simulate', `‚úÖ App simulation created order: ${createData.id}`);
                
                // Step 4: Immediate refresh (like React Query invalidation)
                const { data: refreshData, error: refreshError } = await supabase.from('orders').select('*');
                if (refreshError) {
                    log('simulate', `‚ùå Refresh failed: ${refreshError.message}`, 'error');
                    updateStatus('simulate', '‚ùå Refresh Failed', 'error');
                    return;
                }
                
                const foundInRefresh = refreshData.find(o => o.id === appTestId);
                if (foundInRefresh) {
                    log('simulate', 'üéâ APP SIMULATION SUCCESS! Order immediately available', 'success');
                    updateStatus('simulate', '‚úÖ Perfect', 'success');
                    testResults.appSimulation = true;
                } else {
                    log('simulate', '‚ùå App simulation failed - order not found in refresh', 'error');
                    updateStatus('simulate', '‚ùå Sim Failed', 'error');
                    testResults.appSimulation = false;
                }
                
                showResults();
                
            } catch (error) {
                log('simulate', `‚ùå Simulation exception: ${error.message}`, 'error');
                updateStatus('simulate', '‚ùå Exception', 'error');
                testResults.appSimulation = false;
                showResults();
            }
        }
        
        function showResults() {
            const results = document.getElementById('final-results');
            const conclusion = document.getElementById('conclusion');
            
            const summary = [
                `Client: ${testResults.client ? '‚úÖ' : '‚ùå'}`,
                `Auth: ${testResults.auth ? '‚úÖ' : '‚ùå'}`,
                `Load: ${testResults.load ? '‚úÖ' : '‚ùå'}`,
                `Create: ${testResults.create ? '‚úÖ' : '‚ùå'}`,
                `Persist: ${testResults.persistence === true ? '‚úÖ' : testResults.persistence === 'partial' ? '‚ö†Ô∏è' : '‚ùå'}`,
                `App Sim: ${testResults.appSimulation ? '‚úÖ' : '‚ùå'}`
            ].join(' | ');
            
            results.innerHTML = `<span style="color: #0f0">${summary}</span>`;
            
            const allWorking = testResults.client && testResults.auth && testResults.load && 
                             testResults.create && testResults.persistence === true && testResults.appSimulation;
            
            if (allWorking) {
                conclusion.innerHTML = '<span style="color: #4f4; font-size: 18px;">üéâ ALL TESTS PASSED! PERSISTENCE IS WORKING PERFECTLY!</span><br>' +
                                     '<span style="color: #0f0;">The issue has been resolved. Orders will now persist correctly in the React app.</span>';
            } else {
                conclusion.innerHTML = '<span style="color: #f44; font-size: 18px;">‚ùå Some tests failed. Persistence issue still exists.</span><br>' +
                                     '<span style="color: #fa4;">Check the individual test logs above to identify the specific problem.</span>';
            }
        }
    </script>
</body>
</html>