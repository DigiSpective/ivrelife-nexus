<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Supabase Persistence Test - IV RELIFE Nexus</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .test-card h3 {
            margin-top: 0;
            color: #34495e;
            font-size: 16px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            color: #f39c12;
            font-weight: bold;
        }
        .info {
            color: #3498db;
            font-weight: bold;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #ecf0f1;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #27ae60; }
        .status-error { background-color: #e74c3c; }
        .status-warning { background-color: #f39c12; }
        .status-pending { background-color: #bdc3c7; }
        .summary {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .summary h2 {
            color: white;
            border-bottom: 2px solid #3498db;
        }
        .quick-actions {
            text-align: center;
            margin-bottom: 30px;
        }
        .quick-actions button {
            background: #e74c3c;
            margin: 0 10px;
            padding: 15px 25px;
            font-size: 16px;
        }
        .quick-actions button:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Comprehensive Supabase Persistence Test</h1>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
            Test all aspects of Supabase persistence: Customers, Orders, Claims, Shipments
        </p>

        <div class="quick-actions">
            <button onclick="runAllTests()" id="runAllBtn">üöÄ Run All Tests</button>
            <button onclick="clearAllResults()">üóëÔ∏è Clear Results</button>
        </div>

        <!-- Database Connection Test -->
        <div class="section">
            <h2>üîó Database Connection & Table Access</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-connection"></span>Connection Test</h3>
                    <button onclick="testConnection()">Test Connection</button>
                    <div class="result" id="result-connection"></div>
                </div>
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-auth"></span>Authentication</h3>
                    <button onclick="testAuth()">Test Auth</button>
                    <button onclick="signInTestUser()">Sign In Test User</button>
                    <div class="result" id="result-auth"></div>
                </div>
            </div>
        </div>

        <!-- Customers Persistence Test -->
        <div class="section">
            <h2>üë• Customers Persistence</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-customer-load"></span>Load Customers</h3>
                    <button onclick="testLoadCustomers()">Load Customers</button>
                    <div class="result" id="result-customer-load"></div>
                </div>
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-customer-create"></span>Create Customer</h3>
                    <button onclick="testCreateCustomer()">Create Customer</button>
                    <div class="result" id="result-customer-create"></div>
                </div>
            </div>
        </div>

        <!-- Orders Persistence Test -->
        <div class="section">
            <h2>üì¶ Orders Persistence</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-order-load"></span>Load Orders</h3>
                    <button onclick="testLoadOrders()">Load Orders</button>
                    <div class="result" id="result-order-load"></div>
                </div>
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-order-create"></span>Create Order</h3>
                    <button onclick="testCreateOrder()">Create Order</button>
                    <div class="result" id="result-order-create"></div>
                </div>
            </div>
        </div>

        <!-- Claims Persistence Test -->
        <div class="section">
            <h2>üîß Claims Persistence</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-claim-load"></span>Load Claims</h3>
                    <button onclick="testLoadClaims()">Load Claims</button>
                    <div class="result" id="result-claim-load"></div>
                </div>
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-claim-create"></span>Create Claim</h3>
                    <button onclick="testCreateClaim()">Create Claim</button>
                    <div class="result" id="result-claim-create"></div>
                </div>
            </div>
        </div>

        <!-- Shipments Persistence Test -->
        <div class="section">
            <h2>üöö Shipments Persistence</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-shipment-load"></span>Load Shipments</h3>
                    <button onclick="testLoadShipments()">Load Shipments</button>
                    <div class="result" id="result-shipment-load"></div>
                </div>
                <div class="test-card">
                    <h3><span class="status-indicator status-pending" id="status-shipment-create"></span>Create Shipment</h3>
                    <button onclick="testCreateShipment()">Create Shipment</button>
                    <div class="result" id="result-shipment-create"></div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="summary">
            <h2>üìä Test Summary</h2>
            <div id="test-summary">
                <p>Click "Run All Tests" to see results summary here.</p>
            </div>
        </div>
    </div>

    <!-- Include Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://pcyshzqyqtgzgowfmqxx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjeXNoenF5cXRnemdvd2ZtcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY0MTkxMjUsImV4cCI6MjA0MTk5NTEyNX0.u0Jz8ztKKw1HQI3pJrpvkOpd9AjdggM9YuX8QO9-ckI';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let testResults = {
            connection: null,
            auth: null,
            customers: { load: null, create: null },
            orders: { load: null, create: null },
            claims: { load: null, create: null },
            shipments: { load: null, create: null }
        };

        function updateStatus(testId, status) {
            const indicator = document.getElementById(`status-${testId}`);
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        function logResult(testId, message, success = true) {
            const resultDiv = document.getElementById(`result-${testId}`);
            if (resultDiv) {
                const timestamp = new Date().toLocaleTimeString();
                const statusClass = success ? 'success' : 'error';
                resultDiv.innerHTML += `<span class="${statusClass}">[${timestamp}]</span> ${message}\n`;
                resultDiv.scrollTop = resultDiv.scrollHeight;
            }
            
            updateStatus(testId, success ? 'success' : 'error');
        }

        // Connection and Auth Tests
        async function testConnection() {
            try {
                logResult('connection', 'Testing Supabase connection...', true);
                
                const { data, error } = await supabase
                    .from('customers')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    logResult('connection', `Connection failed: ${error.message}`, false);
                    testResults.connection = false;
                } else {
                    logResult('connection', 'Connection successful! ‚úÖ', true);
                    testResults.connection = true;
                }
            } catch (error) {
                logResult('connection', `Connection error: ${error.message}`, false);
                testResults.connection = false;
            }
        }

        async function testAuth() {
            try {
                logResult('auth', 'Testing authentication...', true);
                
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    logResult('auth', `Auth error: ${error.message}`, false);
                    testResults.auth = false;
                } else if (!user) {
                    logResult('auth', 'No authenticated user found', false);
                    testResults.auth = false;
                } else {
                    logResult('auth', `Authenticated as: ${user.email} (${user.id})`, true);
                    testResults.auth = true;
                }
            } catch (error) {
                logResult('auth', `Auth exception: ${error.message}`, false);
                testResults.auth = false;
            }
        }

        async function signInTestUser() {
            try {
                logResult('auth', 'Signing in test user...', true);
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'test@ivrelife.com',
                    password: 'testpassword123'
                });
                
                if (error) {
                    logResult('auth', `Sign in failed: ${error.message}`, false);
                } else {
                    logResult('auth', 'Signed in successfully! ‚úÖ', true);
                    await testAuth();
                }
            } catch (error) {
                logResult('auth', `Sign in error: ${error.message}`, false);
            }
        }

        // Customers Tests
        async function testLoadCustomers() {
            try {
                logResult('customer-load', 'Loading customers from Supabase...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('customer-load', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const { data, error } = await supabase
                    .from('customers')
                    .select('*')
                    .eq('created_by', user.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    logResult('customer-load', `Load error: ${error.message}`, false);
                    testResults.customers.load = false;
                } else {
                    logResult('customer-load', `Loaded ${data.length} customers ‚úÖ`, true);
                    if (data.length > 0) {
                        logResult('customer-load', `Sample: ${data[0].name} (${data[0].email})`, true);
                    }
                    testResults.customers.load = true;
                }
            } catch (error) {
                logResult('customer-load', `Exception: ${error.message}`, false);
                testResults.customers.load = false;
            }
        }

        async function testCreateCustomer() {
            try {
                logResult('customer-create', 'Creating test customer...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('customer-create', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const testCustomer = {
                    id: `test-customer-${Date.now()}`,
                    name: `Test Customer ${new Date().toLocaleTimeString()}`,
                    email: `test${Date.now()}@example.com`,
                    phone: '555-0123',
                    created_by: user.id,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000'
                };
                
                const { data, error } = await supabase
                    .from('customers')
                    .insert(testCustomer)
                    .select();
                
                if (error) {
                    logResult('customer-create', `Create error: ${error.message}`, false);
                    testResults.customers.create = false;
                } else {
                    logResult('customer-create', `Created customer: ${testCustomer.name} ‚úÖ`, true);
                    testResults.customers.create = true;
                }
            } catch (error) {
                logResult('customer-create', `Exception: ${error.message}`, false);
                testResults.customers.create = false;
            }
        }

        // Orders Tests
        async function testLoadOrders() {
            try {
                logResult('order-load', 'Loading orders from Supabase...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('order-load', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('created_by', user.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    logResult('order-load', `Load error: ${error.message}`, false);
                    testResults.orders.load = false;
                } else {
                    logResult('order-load', `Loaded ${data.length} orders ‚úÖ`, true);
                    if (data.length > 0) {
                        logResult('order-load', `Sample: Order ${data[0].id} - $${data[0].total_amount}`, true);
                    }
                    testResults.orders.load = true;
                }
            } catch (error) {
                logResult('order-load', `Exception: ${error.message}`, false);
                testResults.orders.load = false;
            }
        }

        async function testCreateOrder() {
            try {
                logResult('order-create', 'Creating test order...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('order-create', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const testOrder = {
                    id: `test-order-${Date.now()}`,
                    status: 'pending',
                    total_amount: 99.99,
                    created_by: user.id,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000',
                    items: JSON.stringify([{ product: 'Test Product', qty: 1, price: 99.99 }])
                };
                
                const { data, error } = await supabase
                    .from('orders')
                    .insert(testOrder)
                    .select();
                
                if (error) {
                    logResult('order-create', `Create error: ${error.message}`, false);
                    testResults.orders.create = false;
                } else {
                    logResult('order-create', `Created order: ${testOrder.id} ($${testOrder.total_amount}) ‚úÖ`, true);
                    testResults.orders.create = true;
                }
            } catch (error) {
                logResult('order-create', `Exception: ${error.message}`, false);
                testResults.orders.create = false;
            }
        }

        // Claims Tests
        async function testLoadClaims() {
            try {
                logResult('claim-load', 'Loading claims from Supabase...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('claim-load', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const { data, error } = await supabase
                    .from('claims')
                    .select('*')
                    .eq('created_by', user.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    logResult('claim-load', `Load error: ${error.message}`, false);
                    testResults.claims.load = false;
                } else {
                    logResult('claim-load', `Loaded ${data.length} claims ‚úÖ`, true);
                    if (data.length > 0) {
                        logResult('claim-load', `Sample: ${data[0].reason} (${data[0].status})`, true);
                    }
                    testResults.claims.load = true;
                }
            } catch (error) {
                logResult('claim-load', `Exception: ${error.message}`, false);
                testResults.claims.load = false;
            }
        }

        async function testCreateClaim() {
            try {
                logResult('claim-create', 'Creating test claim...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('claim-create', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const testClaim = {
                    id: `test-claim-${Date.now()}`,
                    reason: `Test claim created at ${new Date().toLocaleTimeString()}`,
                    status: 'submitted',
                    description: 'This is a test claim for persistence testing',
                    created_by: user.id,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000'
                };
                
                const { data, error } = await supabase
                    .from('claims')
                    .insert(testClaim)
                    .select();
                
                if (error) {
                    logResult('claim-create', `Create error: ${error.message}`, false);
                    testResults.claims.create = false;
                } else {
                    logResult('claim-create', `Created claim: ${testClaim.reason} ‚úÖ`, true);
                    testResults.claims.create = true;
                }
            } catch (error) {
                logResult('claim-create', `Exception: ${error.message}`, false);
                testResults.claims.create = false;
            }
        }

        // Shipments Tests
        async function testLoadShipments() {
            try {
                logResult('shipment-load', 'Loading shipments from Supabase...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('shipment-load', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const { data, error } = await supabase
                    .from('shipments')
                    .select('*')
                    .eq('created_by', user.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    logResult('shipment-load', `Load error: ${error.message}`, false);
                    testResults.shipments.load = false;
                } else {
                    logResult('shipment-load', `Loaded ${data.length} shipments ‚úÖ`, true);
                    if (data.length > 0) {
                        logResult('shipment-load', `Sample: ${data[0].carrier} - ${data[0].status}`, true);
                    }
                    testResults.shipments.load = true;
                }
            } catch (error) {
                logResult('shipment-load', `Exception: ${error.message}`, false);
                testResults.shipments.load = false;
            }
        }

        async function testCreateShipment() {
            try {
                logResult('shipment-create', 'Creating test shipment...', true);
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    logResult('shipment-create', 'No authenticated user - please sign in first', false);
                    return;
                }
                
                const testShipment = {
                    id: `test-shipment-${Date.now()}`,
                    order_id: `test-order-${Date.now()}`,
                    carrier: 'Test Carrier',
                    service_level: 'Standard',
                    status: 'PENDING',
                    cost_usd: 15.99,
                    created_by: user.id,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000'
                };
                
                const { data, error } = await supabase
                    .from('shipments')
                    .insert(testShipment)
                    .select();
                
                if (error) {
                    logResult('shipment-create', `Create error: ${error.message}`, false);
                    testResults.shipments.create = false;
                } else {
                    logResult('shipment-create', `Created shipment: ${testShipment.carrier} ($${testShipment.cost_usd}) ‚úÖ`, true);
                    testResults.shipments.create = true;
                }
            } catch (error) {
                logResult('shipment-create', `Exception: ${error.message}`, false);
                testResults.shipments.create = false;
            }
        }

        // Utility Functions
        async function runAllTests() {
            const runAllBtn = document.getElementById('runAllBtn');
            runAllBtn.disabled = true;
            runAllBtn.textContent = 'Running Tests...';
            
            try {
                // Reset all status indicators
                document.querySelectorAll('.status-indicator').forEach(indicator => {
                    indicator.className = 'status-indicator status-pending';
                });
                
                // Run all tests in sequence
                await testConnection();
                await testAuth();
                await testLoadCustomers();
                await testCreateCustomer();
                await testLoadOrders();
                await testCreateOrder();
                await testLoadClaims();
                await testCreateClaim();
                await testLoadShipments();
                await testCreateShipment();
                
                // Show summary
                updateTestSummary();
            } finally {
                runAllBtn.disabled = false;
                runAllBtn.textContent = 'üöÄ Run All Tests';
            }
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('test-summary');
            let passedTests = 0;
            let totalTests = 0;
            
            const flatResults = [
                testResults.connection,
                testResults.auth,
                testResults.customers.load,
                testResults.customers.create,
                testResults.orders.load,
                testResults.orders.create,
                testResults.claims.load,
                testResults.claims.create,
                testResults.shipments.load,
                testResults.shipments.create
            ];
            
            flatResults.forEach(result => {
                if (result !== null) {
                    totalTests++;
                    if (result === true) passedTests++;
                }
            });
            
            const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            
            summaryDiv.innerHTML = `
                <h3>üìä Overall Results</h3>
                <p><strong>Tests Passed:</strong> ${passedTests} / ${totalTests} (${successRate}%)</p>
                <div style="margin-top: 15px;">
                    <h4>‚úÖ Successful Tests:</h4>
                    ${testResults.connection ? '‚Ä¢ Database Connection<br>' : ''}
                    ${testResults.auth ? '‚Ä¢ Authentication<br>' : ''}
                    ${testResults.customers.load ? '‚Ä¢ Load Customers<br>' : ''}
                    ${testResults.customers.create ? '‚Ä¢ Create Customer<br>' : ''}
                    ${testResults.orders.load ? '‚Ä¢ Load Orders<br>' : ''}
                    ${testResults.orders.create ? '‚Ä¢ Create Order<br>' : ''}
                    ${testResults.claims.load ? '‚Ä¢ Load Claims<br>' : ''}
                    ${testResults.claims.create ? '‚Ä¢ Create Claim<br>' : ''}
                    ${testResults.shipments.load ? '‚Ä¢ Load Shipments<br>' : ''}
                    ${testResults.shipments.create ? '‚Ä¢ Create Shipment<br>' : ''}
                </div>
                ${successRate === 100 ? 
                    '<p style="color: #27ae60; font-size: 18px; font-weight: bold; margin-top: 20px;">üéâ ALL TESTS PASSED! Comprehensive Supabase persistence is working perfectly!</p>' :
                    '<p style="color: #e74c3c; font-size: 16px; margin-top: 20px;">‚ö†Ô∏è Some tests failed. Check individual test results above for details.</p>'
                }
            `;
        }

        function clearAllResults() {
            document.querySelectorAll('.result').forEach(div => {
                div.innerHTML = '';
            });
            document.querySelectorAll('.status-indicator').forEach(indicator => {
                indicator.className = 'status-indicator status-pending';
            });
            document.getElementById('test-summary').innerHTML = '<p>Click "Run All Tests" to see results summary here.</p>';
            
            // Reset test results
            testResults = {
                connection: null,
                auth: null,
                customers: { load: null, create: null },
                orders: { load: null, create: null },
                claims: { load: null, create: null },
                shipments: { load: null, create: null }
            };
        }
    </script>
</body>
</html>