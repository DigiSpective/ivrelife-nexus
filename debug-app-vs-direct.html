<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug App vs Direct</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #111; }
        button { margin: 5px; padding: 8px 16px; background: #333; color: #0f0; border: 1px solid #666; }
        pre { background: #000; padding: 10px; border: 1px solid #333; max-height: 400px; overflow-y: auto; }
        .success { color: #4f4; }
        .error { color: #f44; }
        .warning { color: #fa4; }
    </style>
</head>
<body>
    <h1>üî¨ Debug: App Method vs Direct Supabase</h1>
    
    <div class="test">
        <h2>1. Authentication</h2>
        <button onclick="doAuth()">Sign In</button>
        <div id="auth-status"></div>
        <pre id="auth-log"></pre>
    </div>
    
    <div class="test">
        <h2>2. Create Order (Direct Supabase)</h2>
        <button onclick="createOrderDirect()">Create Order Direct</button>
        <div id="direct-status"></div>
        <pre id="direct-log"></pre>
    </div>
    
    <div class="test">
        <h2>3. Load Orders (Direct Supabase)</h2>
        <button onclick="loadOrdersDirect()">Load Orders Direct</button>
        <div id="load-status"></div>
        <pre id="load-log"></pre>
    </div>
    
    <div class="test">
        <h2>4. Test App createOrder Function</h2>
        <button onclick="testAppCreateOrder()">Test App createOrder</button>
        <div id="app-create-status"></div>
        <pre id="app-create-log"></pre>
    </div>
    
    <div class="test">
        <h2>5. Test App getOrders Function</h2>
        <button onclick="testAppGetOrders()">Test App getOrders</button>
        <div id="app-get-status"></div>
        <pre id="app-get-log"></pre>
    </div>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabase = window.supabase.createClient(
            'https://fhqgqhzwrnogwdqovbay.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZocWdxaHp3cm5vZ3dkcW92YmF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY2MzkzNDAsImV4cCI6MjA0MjIxNTM0MH0.mwdRPcFCp8qQBw_WTPPz4v8lJYrAnHYB6ByU5Y3-aao'
        );
        
        let currentUser = null;
        let directOrderId = null;
        let appOrderId = null;

        function setStatus(id, status, type = 'info') {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = status;
                el.className = type;
            }
        }

        function log(id, message) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
                el.scrollTop = el.scrollHeight;
            }
        }

        async function doAuth() {
            try {
                setStatus('auth-status', 'Signing in...', 'warning');
                log('auth-log', 'Attempting to sign in with admin@iv-relife.com');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@iv-relife.com',
                    password: '123456789'
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                setStatus('auth-status', `‚úÖ Signed in: ${currentUser.email}`, 'success');
                log('auth-log', `SUCCESS: User ID = ${currentUser.id}`);
                
            } catch (error) {
                setStatus('auth-status', `‚ùå Auth failed: ${error.message}`, 'error');
                log('auth-log', `ERROR: ${error.message}`);
            }
        }

        async function createOrderDirect() {
            if (!currentUser) {
                setStatus('direct-status', '‚ùå Please sign in first', 'error');
                return;
            }
            
            try {
                setStatus('direct-status', 'Creating order...', 'warning');
                
                directOrderId = `direct-test-${Date.now()}`;
                const orderData = {
                    id: directOrderId,
                    retailer_id: '550e8400-e29b-41d4-a716-446655440000',
                    customer_id: 'test-customer-123',
                    status: 'pending',
                    total_amount: 199.99,
                    items: JSON.stringify([{ product: 'Direct Test Product', qty: 1, price: 199.99 }]),
                    created_by: currentUser.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                log('direct-log', `Creating order: ${directOrderId}`);
                log('direct-log', `User ID: ${currentUser.id}`);
                log('direct-log', `Order data: ${JSON.stringify(orderData, null, 2)}`);
                
                const { data, error } = await supabase
                    .from('orders')
                    .insert(orderData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                setStatus('direct-status', `‚úÖ Order created: ${data.id}`, 'success');
                log('direct-log', `SUCCESS: Order created in database`);
                log('direct-log', `Returned data: ${JSON.stringify(data, null, 2)}`);
                
            } catch (error) {
                setStatus('direct-status', `‚ùå Failed: ${error.message}`, 'error');
                log('direct-log', `ERROR: ${error.message}`);
                log('direct-log', `Full error: ${JSON.stringify(error, null, 2)}`);
            }
        }

        async function loadOrdersDirect() {
            if (!currentUser) {
                setStatus('load-status', '‚ùå Please sign in first', 'error');
                return;
            }
            
            try {
                setStatus('load-status', 'Loading orders...', 'warning');
                log('load-log', `Loading orders for user: ${currentUser.id}`);
                
                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('created_by', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                setStatus('load-status', `‚úÖ Found ${data.length} orders`, 'success');
                log('load-log', `SUCCESS: Loaded ${data.length} orders`);
                
                if (data.length > 0) {
                    log('load-log', `Orders found:`);
                    data.forEach(order => {
                        log('load-log', `- ${order.id} (${order.status}) - $${order.total_amount}`);
                    });
                } else {
                    log('load-log', 'No orders found for this user');
                }
                
                // Check if our direct order is there
                if (directOrderId) {
                    const foundDirect = data.find(o => o.id === directOrderId);
                    log('load-log', `Direct order ${directOrderId}: ${foundDirect ? 'FOUND' : 'NOT FOUND'}`);
                }
                
                // Check if any app-created orders are there
                if (appOrderId) {
                    const foundApp = data.find(o => o.id === appOrderId);
                    log('load-log', `App order ${appOrderId}: ${foundApp ? 'FOUND' : 'NOT FOUND'}`);
                }
                
            } catch (error) {
                setStatus('load-status', `‚ùå Failed: ${error.message}`, 'error');
                log('load-log', `ERROR: ${error.message}`);
            }
        }

        async function testAppCreateOrder() {
            if (!currentUser) {
                setStatus('app-create-status', '‚ùå Please sign in first', 'error');
                return;
            }
            
            try {
                setStatus('app-create-status', 'Testing app createOrder...', 'warning');
                log('app-create-log', 'Testing the app createOrder function...');
                
                // Simulate what the app does
                appOrderId = `app-test-${Date.now()}`;
                const orderData = {
                    id: appOrderId,
                    retailer_id: 'ret-1',
                    location_id: 'loc-1',
                    customer_id: 'test-customer-456',
                    status: 'pending',
                    total_amount: 299.99,
                    items: [{ product: 'App Test Product', qty: 1, price: 299.99 }],
                    created_by: currentUser.id
                };
                
                log('app-create-log', `Order data being sent to app: ${JSON.stringify(orderData, null, 2)}`);
                
                // Try to call the app's createOrder function
                // This would need to be done in the actual app context
                // For now, let's simulate what it might do
                
                const response = await fetch('/api/createOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    setStatus('app-create-status', '‚úÖ App order created', 'success');
                    log('app-create-log', `SUCCESS: ${JSON.stringify(result, null, 2)}`);
                } else {
                    setStatus('app-create-status', '‚ùå App API not available', 'warning');
                    log('app-create-log', 'App API not available in this context');
                    log('app-create-log', 'Would need to test this in the actual app');
                }
                
            } catch (error) {
                setStatus('app-create-status', '‚ùå App test failed', 'warning');
                log('app-create-log', `This test needs to be run in the app context`);
                log('app-create-log', `Error: ${error.message}`);
            }
        }

        async function testAppGetOrders() {
            try {
                setStatus('app-get-status', 'Testing app getOrders...', 'warning');
                log('app-get-log', 'Testing the app getOrders function...');
                
                // Try to call the app's getOrders function
                const response = await fetch('/api/getOrders');
                
                if (response.ok) {
                    const result = await response.json();
                    setStatus('app-get-status', '‚úÖ App getOrders worked', 'success');
                    log('app-get-log', `SUCCESS: ${JSON.stringify(result, null, 2)}`);
                } else {
                    setStatus('app-get-status', '‚ùå App API not available', 'warning');
                    log('app-get-log', 'App API not available in this context');
                    log('app-get-log', 'Would need to test this in the actual app');
                }
                
            } catch (error) {
                setStatus('app-get-status', '‚ùå App test failed', 'warning');
                log('app-get-log', `This test needs to be run in the app context`);
                log('app-get-log', `Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>