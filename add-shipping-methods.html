<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Shipping Methods - IV ReLife Nexus</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }
        .log div {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .log .success {
            color: #4CAF50;
        }
        .log .error {
            color: #f44336;
        }
        .log .info {
            color: #2196F3;
        }
        .log .warning {
            color: #FF9800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöö Add Shipping Methods to Database</h1>
        <p>This utility will add shipping methods for FedEx, UPS, and USPS to your Supabase database.</p>

        <button id="addMethodsBtn" onclick="addShippingMethods()">Add Shipping Methods</button>
        <button id="addLTLBtn" onclick="addLTLShipping()">Add LTL Freight</button>
        <button onclick="verifyMethods()">Verify Methods</button>
        <button onclick="clearLog()">Clear Log</button>

        <div id="log" class="log"></div>

        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qeiyxwuyhetnrnundpep.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlaXl4d3V5aGV0bnJudW5kcGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDQyMTEsImV4cCI6MjA3NDIyMDIxMX0.fkmN8zQXVv3m7VBcpIj1KfkspSb4a6K93RZVT8qiKak';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        async function addShippingMethods() {
            const btn = document.getElementById('addMethodsBtn');
            btn.disabled = true;

            try {
                log('üöÄ Starting to add shipping methods...', 'info');

                // Get all providers
                log('üì¶ Fetching shipping providers...', 'info');
                const { data: providers, error: providerError } = await supabase
                    .from('shipping_providers')
                    .select('*');

                if (providerError) {
                    log(`‚ùå Error fetching providers: ${providerError.message}`, 'error');
                    return;
                }

                log(`‚úÖ Found ${providers.length} providers: ${providers.map(p => p.name).join(', ')}`, 'success');

                // Find specific providers
                const fedex = providers.find(p => p.api_identifier === 'fedex');
                const ups = providers.find(p => p.api_identifier === 'ups');
                const usps = providers.find(p => p.api_identifier === 'usps');

                const methodsToAdd = [];

                // UPS methods
                if (ups) {
                    log(`üìã Adding UPS methods (provider_id: ${ups.id})...`, 'info');
                    methodsToAdd.push(
                        { provider_id: ups.id, name: 'UPS Ground', code: 'ups_ground', speed_estimate: '1-5 business days', supports_ltl: false, base_cost: 15.99, active: true },
                        { provider_id: ups.id, name: 'UPS 2nd Day Air', code: 'ups_2day', speed_estimate: '2 business days', supports_ltl: false, base_cost: 24.99, active: true },
                        { provider_id: ups.id, name: 'UPS Next Day Air', code: 'ups_express', speed_estimate: '1 business day', supports_ltl: false, base_cost: 45.99, active: true },
                        { provider_id: ups.id, name: 'UPS White Glove', code: 'ups_white_glove', speed_estimate: '5-14 business days', supports_ltl: true, base_cost: 700.00, active: true }
                    );
                }

                // FedEx methods
                if (fedex) {
                    log(`üìã Adding FedEx methods (provider_id: ${fedex.id})...`, 'info');
                    methodsToAdd.push(
                        { provider_id: fedex.id, name: 'FedEx Ground', code: 'fedex_ground', speed_estimate: '1-5 business days', supports_ltl: false, base_cost: 16.49, active: true },
                        { provider_id: fedex.id, name: 'FedEx 2Day', code: 'fedex_2day', speed_estimate: '2 business days', supports_ltl: false, base_cost: 24.99, active: true },
                        { provider_id: fedex.id, name: 'FedEx Express', code: 'fedex_express', speed_estimate: '1 business day', supports_ltl: false, base_cost: 45.99, active: true },
                        { provider_id: fedex.id, name: 'FedEx Freight', code: 'fedex_freight', speed_estimate: '3-7 business days', supports_ltl: true, base_cost: 299.99, active: true }
                    );
                }

                // USPS methods
                if (usps) {
                    log(`üìã Adding USPS methods (provider_id: ${usps.id})...`, 'info');
                    methodsToAdd.push(
                        { provider_id: usps.id, name: 'USPS Priority Mail', code: 'usps_priority', speed_estimate: '1-3 business days', supports_ltl: false, base_cost: 12.99, active: true },
                        { provider_id: usps.id, name: 'USPS Priority Mail Express', code: 'usps_express', speed_estimate: '1-2 business days', supports_ltl: false, base_cost: 34.99, active: true },
                        { provider_id: usps.id, name: 'USPS Ground Advantage', code: 'usps_ground', speed_estimate: '2-5 business days', supports_ltl: false, base_cost: 9.99, active: true }
                    );
                }

                log(`üíæ Inserting ${methodsToAdd.length} shipping methods...`, 'info');

                // Insert all methods
                const { data: insertedMethods, error: insertError } = await supabase
                    .from('shipping_methods')
                    .insert(methodsToAdd)
                    .select();

                if (insertError) {
                    log(`‚ùå Error inserting methods: ${insertError.message}`, 'error');
                    return;
                }

                log(`‚úÖ Successfully added ${insertedMethods.length} shipping methods!`, 'success');

                // Show verification
                await verifyMethods();

            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function addLTLShipping() {
            const btn = document.getElementById('addLTLBtn');
            btn.disabled = true;

            try {
                log('üöõ Starting to add LTL Freight shipping...', 'info');

                // Check if LTL provider already exists
                log('üì¶ Checking for existing LTL Freight provider...', 'info');
                let { data: existingProvider, error: checkError } = await supabase
                    .from('shipping_providers')
                    .select('*')
                    .eq('api_identifier', 'ltl_freight')
                    .single();

                let ltlProvider = existingProvider;

                // If not exists, create it
                if (!existingProvider) {
                    log('‚ûï Creating LTL Freight provider...', 'info');
                    const { data: newProvider, error: providerError } = await supabase
                        .from('shipping_providers')
                        .insert({
                            name: 'LTL Freight',
                            api_identifier: 'ltl_freight',
                            active: true
                        })
                        .select()
                        .single();

                    if (providerError) {
                        log(`‚ùå Error creating LTL provider: ${providerError.message}`, 'error');
                        return;
                    }

                    ltlProvider = newProvider;
                    log(`‚úÖ Created LTL Freight provider (ID: ${ltlProvider.id})`, 'success');
                } else {
                    log(`‚úÖ LTL Freight provider already exists (ID: ${ltlProvider.id})`, 'success');
                }

                // Add LTL shipping methods
                const ltlMethods = [
                    { provider_id: ltlProvider.id, name: 'Standard LTL Freight', code: 'ltl_standard', speed_estimate: '7-21 business days', supports_ltl: true, base_cost: 299.99, active: true },
                    { provider_id: ltlProvider.id, name: 'Expedited LTL Freight', code: 'ltl_expedited', speed_estimate: '3-7 business days', supports_ltl: true, base_cost: 449.99, active: true },
                    { provider_id: ltlProvider.id, name: 'LTL with Liftgate', code: 'ltl_liftgate', speed_estimate: '7-21 business days', supports_ltl: true, base_cost: 349.99, active: true },
                    { provider_id: ltlProvider.id, name: 'LTL Inside Delivery', code: 'ltl_inside', speed_estimate: '7-21 business days', supports_ltl: true, base_cost: 399.99, active: true }
                ];

                log(`üíæ Inserting ${ltlMethods.length} LTL shipping methods...`, 'info');

                const { data: insertedMethods, error: insertError } = await supabase
                    .from('shipping_methods')
                    .insert(ltlMethods)
                    .select();

                if (insertError) {
                    log(`‚ùå Error inserting LTL methods: ${insertError.message}`, 'error');
                    return;
                }

                log(`‚úÖ Successfully added ${insertedMethods.length} LTL shipping methods!`, 'success');
                log('üìã LTL Methods added:', 'success');
                insertedMethods.forEach(method => {
                    log(`   - ${method.name} ($${method.base_cost})`, 'info');
                });

                // Show verification
                await verifyMethods();

            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function verifyMethods() {
            try {
                log('üîç Verifying shipping methods...', 'info');

                const { data: methods, error } = await supabase
                    .from('shipping_methods')
                    .select(`
                        *,
                        shipping_providers (
                            name,
                            api_identifier
                        )
                    `)
                    .order('shipping_providers(name)', { ascending: true });

                if (error) {
                    log(`‚ùå Error fetching methods: ${error.message}`, 'error');
                    return;
                }

                log(`‚úÖ Found ${methods.length} shipping methods in database`, 'success');

                // Display results in a table
                const resultsDiv = document.getElementById('results');
                let html = '<h2>Shipping Methods in Database</h2>';
                html += '<table>';
                html += '<thead><tr><th>Provider</th><th>Method</th><th>Code</th><th>Speed</th><th>LTL</th><th>Base Cost</th><th>Active</th></tr></thead>';
                html += '<tbody>';

                methods.forEach(method => {
                    html += `<tr>
                        <td>${method.shipping_providers?.name || 'Unknown'}</td>
                        <td>${method.name}</td>
                        <td>${method.code || '-'}</td>
                        <td>${method.speed_estimate || '-'}</td>
                        <td>${method.supports_ltl ? '‚úÖ' : '‚ùå'}</td>
                        <td>$${method.base_cost || 0}</td>
                        <td>${method.active ? '‚úÖ' : '‚ùå'}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                resultsDiv.innerHTML = html;

                // Count by provider
                const providerCounts = methods.reduce((acc, method) => {
                    const provider = method.shipping_providers?.name || 'Unknown';
                    acc[provider] = (acc[provider] || 0) + 1;
                    return acc;
                }, {});

                log('üìä Methods per provider:', 'info');
                Object.entries(providerCounts).forEach(([provider, count]) => {
                    log(`   ${provider}: ${count} methods`, 'info');
                });

            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
            }
        }

        // Auto-verify on load
        window.addEventListener('load', () => {
            log('üåê Connected to Supabase', 'success');
            log('üîç Checking existing shipping methods...', 'info');
            verifyMethods();
        });
    </script>
</body>
</html>
