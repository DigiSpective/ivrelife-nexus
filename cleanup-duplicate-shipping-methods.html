<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Duplicate Shipping Methods - IV ReLife Nexus</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #f44336;
            padding-bottom: 10px;
        }
        button {
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover {
            background: #d32f2f;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.safe {
            background: #4CAF50;
        }
        button.safe:hover {
            background: #45a049;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
        }
        .log div {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .log .success {
            color: #4CAF50;
        }
        .log .error {
            color: #f44336;
        }
        .log .info {
            color: #2196F3;
        }
        .log .warning {
            color: #FF9800;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #f44336;
            color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .duplicate {
            background: #ffebee !important;
        }
        .keep {
            background: #e8f5e9 !important;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Cleanup Duplicate Shipping Methods</h1>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Warning:</strong> This tool will remove duplicate shipping methods, keeping only the first occurrence of each unique method code per provider.
        </div>

        <button id="analyzeBtn" class="safe" onclick="analyzeDuplicates()">Analyze Duplicates</button>
        <button id="cleanupBtn" onclick="cleanupDuplicates()" disabled>Remove Duplicates</button>
        <button class="safe" onclick="verifyMethods()">Verify Current State</button>
        <button class="safe" onclick="clearLog()">Clear Log</button>

        <div id="log" class="log"></div>

        <div id="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qeiyxwuyhetnrnundpep.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFlaXl4d3V5aGV0bnJudW5kcGVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDQyMTEsImV4cCI6MjA3NDIyMDIxMX0.fkmN8zQXVv3m7VBcpIj1KfkspSb4a6K93RZVT8qiKak';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let duplicatesToDelete = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        async function analyzeDuplicates() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            duplicatesToDelete = [];

            try {
                log('üîç Analyzing shipping methods for duplicates...', 'info');

                // Get all methods with provider info
                const { data: methods, error } = await supabase
                    .from('shipping_methods')
                    .select(`
                        *,
                        shipping_providers (
                            name,
                            api_identifier
                        )
                    `)
                    .order('created_at', { ascending: true });

                if (error) {
                    log(`‚ùå Error fetching methods: ${error.message}`, 'error');
                    return;
                }

                log(`üìä Found ${methods.length} total shipping methods`, 'info');

                // Group by provider_id and code to find duplicates
                const grouped = {};
                methods.forEach(method => {
                    const key = `${method.provider_id}_${method.code}`;
                    if (!grouped[key]) {
                        grouped[key] = [];
                    }
                    grouped[key].push(method);
                });

                // Find duplicates
                const duplicates = [];
                const toKeep = [];
                const toDelete = [];

                Object.entries(grouped).forEach(([key, methodList]) => {
                    if (methodList.length > 1) {
                        // Keep the first one (oldest by created_at)
                        toKeep.push(methodList[0]);
                        // Mark rest for deletion
                        const dupes = methodList.slice(1);
                        toDelete.push(...dupes);
                        duplicates.push({
                            provider: methodList[0].shipping_providers?.name,
                            code: methodList[0].code,
                            name: methodList[0].name,
                            count: methodList.length,
                            keep: methodList[0],
                            delete: dupes
                        });
                    }
                });

                duplicatesToDelete = toDelete;

                if (duplicates.length === 0) {
                    log('‚úÖ No duplicates found! Database is clean.', 'success');
                    document.getElementById('cleanupBtn').disabled = true;
                    await verifyMethods();
                    return;
                }

                log(`‚ö†Ô∏è  Found ${duplicates.length} sets of duplicates`, 'warning');
                log(`üóëÔ∏è  Will delete ${toDelete.length} duplicate records`, 'warning');

                // Display duplicates in a table
                const resultsDiv = document.getElementById('results');
                let html = '<h2>Duplicate Shipping Methods Found</h2>';
                html += '<p><strong>Strategy:</strong> Keep oldest record (first created), delete newer duplicates</p>';
                html += '<table>';
                html += '<thead><tr><th>Provider</th><th>Method</th><th>Code</th><th>Count</th><th>Action</th></tr></thead>';
                html += '<tbody>';

                duplicates.forEach(dup => {
                    // Keep row
                    html += `<tr class="keep">
                        <td>${dup.provider}</td>
                        <td>${dup.name}</td>
                        <td>${dup.code}</td>
                        <td>${dup.count} duplicates</td>
                        <td><strong>‚úÖ KEEP</strong> (ID: ${dup.keep.id.substring(0, 8)}...)</td>
                    </tr>`;

                    // Delete rows
                    dup.delete.forEach(del => {
                        html += `<tr class="duplicate">
                            <td>${dup.provider}</td>
                            <td>${del.name}</td>
                            <td>${del.code}</td>
                            <td></td>
                            <td><strong>üóëÔ∏è  DELETE</strong> (ID: ${del.id.substring(0, 8)}...)</td>
                        </tr>`;
                    });
                });

                html += '</tbody></table>';

                html += '<h3>Summary</h3>';
                html += '<ul>';
                duplicates.forEach(dup => {
                    html += `<li><strong>${dup.provider} - ${dup.name}</strong>: ${dup.count} copies (keep 1, delete ${dup.count - 1})</li>`;
                });
                html += '</ul>';

                resultsDiv.innerHTML = html;

                document.getElementById('cleanupBtn').disabled = false;
                log('‚úÖ Analysis complete. Review the duplicates above, then click "Remove Duplicates"', 'success');

            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function cleanupDuplicates() {
            if (duplicatesToDelete.length === 0) {
                log('‚ö†Ô∏è  No duplicates to delete. Run "Analyze Duplicates" first.', 'warning');
                return;
            }

            const confirmed = confirm(`Are you sure you want to delete ${duplicatesToDelete.length} duplicate shipping methods?\n\nThis action cannot be undone.`);
            if (!confirmed) {
                log('‚ùå Cleanup cancelled by user', 'warning');
                return;
            }

            const btn = document.getElementById('cleanupBtn');
            btn.disabled = true;

            try {
                log(`üóëÔ∏è  Starting cleanup of ${duplicatesToDelete.length} duplicates...`, 'info');

                const idsToDelete = duplicatesToDelete.map(m => m.id);

                // Delete in batches of 10 to avoid overwhelming the API
                const batchSize = 10;
                let deletedCount = 0;

                for (let i = 0; i < idsToDelete.length; i += batchSize) {
                    const batch = idsToDelete.slice(i, i + batchSize);

                    const { error: deleteError } = await supabase
                        .from('shipping_methods')
                        .delete()
                        .in('id', batch);

                    if (deleteError) {
                        log(`‚ùå Error deleting batch: ${deleteError.message}`, 'error');
                        continue;
                    }

                    deletedCount += batch.length;
                    log(`‚úÖ Deleted ${deletedCount}/${idsToDelete.length} duplicates...`, 'info');
                }

                log(`‚úÖ Successfully deleted ${deletedCount} duplicate shipping methods!`, 'success');
                log('üîÑ Verifying final state...', 'info');

                duplicatesToDelete = [];
                document.getElementById('cleanupBtn').disabled = true;

                // Wait a moment for database to update
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Verify final state
                await verifyMethods();

            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function verifyMethods() {
            try {
                log('üîç Verifying current shipping methods...', 'info');

                const { data: methods, error } = await supabase
                    .from('shipping_methods')
                    .select(`
                        *,
                        shipping_providers (
                            name,
                            api_identifier
                        )
                    `)
                    .order('shipping_providers(name)', { ascending: true });

                if (error) {
                    log(`‚ùå Error fetching methods: ${error.message}`, 'error');
                    return;
                }

                log(`‚úÖ Found ${methods.length} total shipping methods`, 'success');

                // Count by provider
                const providerCounts = methods.reduce((acc, method) => {
                    const provider = method.shipping_providers?.name || 'Unknown';
                    acc[provider] = (acc[provider] || 0) + 1;
                    return acc;
                }, {});

                log('üìä Methods per provider:', 'info');
                Object.entries(providerCounts).forEach(([provider, count]) => {
                    log(`   ${provider}: ${count} methods`, 'info');
                });

                // Display all methods in a table
                const resultsDiv = document.getElementById('results');
                let html = '<h2>Current Shipping Methods</h2>';
                html += '<table>';
                html += '<thead><tr><th>Provider</th><th>Method</th><th>Code</th><th>Speed</th><th>LTL</th><th>Base Cost</th><th>Active</th></tr></thead>';
                html += '<tbody>';

                methods.forEach(method => {
                    html += `<tr>
                        <td>${method.shipping_providers?.name || 'Unknown'}</td>
                        <td>${method.name}</td>
                        <td>${method.code || '-'}</td>
                        <td>${method.speed_estimate || '-'}</td>
                        <td>${method.supports_ltl ? '‚úÖ' : '‚ùå'}</td>
                        <td>$${method.base_cost || 0}</td>
                        <td>${method.active ? '‚úÖ' : '‚ùå'}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
            }
        }

        // Auto-verify on load
        window.addEventListener('load', () => {
            log('üåê Connected to Supabase', 'success');
            log('üîç Click "Analyze Duplicates" to check for duplicate shipping methods', 'info');
            verifyMethods();
        });
    </script>
</body>
</html>
